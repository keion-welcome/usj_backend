# バリデーション設計方針

## 概要

本システムでは、**DTOレイヤー**と**ユースケースレイヤー**で異なる種類のバリデーションを実装し、多層防御によるデータ品質の確保を行います。

## バリデーション層の責務

### 1. DTOレイヤー（入力バリデーション）

**責務**: クライアントからの入力データの形式的・構文的検証

**実装方法**: Bean Validation（Jakarta Validation）アノテーション

**チェック内容**:
- **必須項目チェック** (`@NotNull`, `@NotBlank`)
- **形式チェック** (`@Email`, `@Pattern`)
- **長さ・範囲チェック** (`@Size`, `@Min`, `@Max`)
- **日付チェック** (`@Past`, `@Future`)

**メリット**:
- Swagger/OpenAPIスキーマに自動反映
- フロントエンドでの型生成時にバリデーション情報が含まれる
- 早期エラー検出（コントローラー層で自動実行）

### 2. ユースケースレイヤー（ビジネスロジックバリデーション）

**責務**: 業務ルール・データ整合性の検証

**実装方法**: プログラマティックバリデーション

**チェック内容**:
- **重複チェック** (メールアドレス等、ニックネームは重複許可)
- **存在確認** (関連データの整合性)
- **業務ルール** (年齢制限：18歳以上150歳以下)

## 実装例

### DTOでの入力バリデーション

```kotlin
data class RegisterRequest(
    @field:NotBlank(message = "メールアドレスは必須です")
    @field:Email(message = "有効なメールアドレスを入力してください")
    @field:Size(max = 255, message = "メールアドレスは255文字以内で入力してください")
    val email: String,
    
    @field:NotBlank(message = "パスワードは必須です")
    @field:Size(min = 8, max = 100, message = "パスワードは8文字以上100文字以内で入力してください")
    @field:Pattern(
        regexp = "^(?=.*[a-z])(?=.*[A-Z])(?=.*\\d)[a-zA-Z\\d@\$!%*?&]{8,}$",
        message = "パスワードは大文字、小文字、数字を含む8文字以上である必要があります"
    )
    val password: String
)
```

### ユースケースでのビジネスロジックバリデーション

```kotlin
fun execute(request: RegisterRequest): AuthResponse {
    // ビジネスルール：メールアドレスの重複チェック
    require(userRepository.findByEmail(request.email) == null) {
        "既に登録されているメールアドレスです。"
    }
    
    // ビジネスルール：パスワードの追加セキュリティチェック
    validatePasswordSecurity(request.password)
    
    // ... 処理続行
}

fun createProfile(profile: Profile): Profile {
    // ビジネスルール：年齢制限チェック（18歳以上150歳以下）
    validateAge(profile.birthdate)
    
    // ビジネスルール：ニックネームの適切性チェック（重複は許可）
    validateNickname(profile.nickname)
    
    // ... 処理続行
}
```

## 現在のビジネスルール

### ユーザー登録
- **メールアドレス重複**: 不可（既存ユーザーとの重複チェック）
- **パスワード強度**: 大文字・小文字・数字を含む8文字以上
- **一般的なパスワード**: 使用不可

### プロフィール作成
- **年齢制限**: 18歳以上150歳以下のみ利用可能
- **ニックネーム重複**: 許可（同じニックネームの使用可能）
- **不適切な単語**: admin, system, test, null, undefined等は使用不可
- **年間パス**: 年齢制限なし（18歳未満でも保護者同意があれば可能）

## バリデーション設計原則

### 1. 責務の分離
- **DTO**: 「形式が正しいか？」
- **ユースケース**: 「業務的に妥当か？」

### 2. Fail Fast原則
- DTOバリデーションで早期にエラーを検出
- 不正なデータがビジネスロジックに到達することを防ぐ

### 3. 一貫性の確保
- 同じ種類のバリデーションは同じ層で実装
- エラーメッセージの統一

### 4. フロントエンド連携
- DTOのバリデーション情報がAPIスキーマに反映
- フロントエンドでリアルタイムバリデーションが可能

## エラーハンドリング

### DTOバリデーションエラー
- HTTP 400 Bad Request
- フィールド単位の詳細エラー情報

### ビジネスロジックバリデーションエラー
- HTTP 400 Bad Request (入力データ起因)
- HTTP 409 Conflict (重複等)
- HTTP 422 Unprocessable Entity (業務ルール違反)

## 今後の拡張

1. **カスタムバリデーター**の追加
2. **国際化対応**（多言語エラーメッセージ）
3. **動的バリデーション**（設定による制御）
4. **監査ログ**（バリデーション失敗の記録） 